name: Compile & Deploy (SFTP)

on:
  push:
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - 'programs/**'
  pull_request:
    paths-ignore:
      - 'programs/**'
  workflow_dispatch:

jobs:
  compile_and_deploy:
    runs-on: ubuntu-latest

    concurrency:
      group: compile-deploy-${{ github.ref }}
      cancel-in-progress: true

    permissions:
      contents: read

    env:
      SFTP_HOST: ${{ vars.SFTP_HOST }}
      SFTP_PORT: ${{ vars.SFTP_PORT }}
      SFTP_USER: ${{ vars.SFTP_USER }}
      SFTP_DESTINATION: ${{ vars.SFTP_DESTINATION }}
      SFTP_PRIVATE_KEY: ${{ secrets.SFTP_PRIVATE_KEY }}
      SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
      SFTP_KNOWN_HOSTS: ${{ secrets.SFTP_KNOWN_HOSTS }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install VICE (petcat)
        run: |
          sudo apt-get update
          sudo apt-get install -y vice acme

      - name: Stamp build info (sha + cache-busting)
        run: |
          set -euo pipefail
          SHA="$(git rev-parse --short HEAD)"
          DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          REF_NAME="${GITHUB_REF_NAME}"

          # Write build info for in-page display.
          cat > build-info.json <<EOF
          {
            "sha": "${SHA}",
            "date": "${DATE}",
            "refName": "${REF_NAME}"
          }
          EOF

          # Replace placeholders to bust browser caches for app/styles/dev bundles.
          for f in index.html debug.html dev.html; do
            if [[ -f "$f" ]]; then
              sed -i "s/__SYS64738_BUILD_SHA__/${SHA}/g" "$f"
            fi
          done

          sed -i "s/__SYS64738_BUILD_SHA__/${SHA}/g" build-info.json
          sed -i "s/__SYS64738_BUILD_DATE__/${DATE}/g" build-info.json

      - name: Compile sources to PRG (and build D64)
        env:
          SYS64738_BUILD_SHA: ${{ github.sha }}
          SYS64738_REF_NAME: ${{ github.ref_name }}
        run: |
          chmod +x compile.sh
          # Use short SHA for filenames
          export SYS64738_BUILD_SHA="$(echo \"$SYS64738_BUILD_SHA\" | cut -c1-7)"
          ./compile.sh
      
      - name: List compiled files
        run: |
          echo "ðŸ“¦ Compiled files:"
          ls -lh programs/*.prg programs/*.d64 2>/dev/null || echo "No files found"
      
      - name: Upload compiled files
        uses: actions/upload-artifact@v4
        with:
          name: compiled-files
          path: |
            programs/*.prg
            programs/*.d64
          retention-days: 30

      - name: Install rsync (and lftp fallback)
        if: ${{ github.event_name != 'pull_request' && env.SFTP_HOST != '' && env.SFTP_USER != '' && env.SFTP_DESTINATION != '' }}
        run: sudo apt-get update && sudo apt-get install -y rsync lftp openssh-client

      - name: Prepare SSH config (known_hosts + optional key)
        if: ${{ github.event_name != 'pull_request' && env.SFTP_HOST != '' && env.SFTP_USER != '' && env.SFTP_DESTINATION != '' }}
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"

          if [[ -n "${SFTP_KNOWN_HOSTS:-}" ]]; then
            printf '%s\n' "$SFTP_KNOWN_HOSTS" > "$HOME/.ssh/known_hosts"
          else
            echo "SFTP_KNOWN_HOSTS is not set; generating known_hosts via ssh-keyscan."
            ssh-keyscan -p "${SFTP_PORT:-22}" "$SFTP_HOST" > "$HOME/.ssh/known_hosts"
          fi
          chmod 600 "$HOME/.ssh/known_hosts"

          if [[ -n "${SFTP_PRIVATE_KEY:-}" ]]; then
            # Normalize CRLF->LF in case the secret was pasted with Windows line endings.
            printf '%s\n' "$SFTP_PRIVATE_KEY" | tr -d '\r' > "$HOME/.ssh/id_rsa"
            chmod 600 "$HOME/.ssh/id_rsa"
          fi

      - name: Verify SSH key authentication (non-interactive)
        if: ${{ github.event_name != 'pull_request' && env.SFTP_HOST != '' && env.SFTP_USER != '' && env.SFTP_DESTINATION != '' && env.SFTP_PRIVATE_KEY != '' }}
        shell: bash
        run: |
          set -euo pipefail
          SFTP_PORT="${SFTP_PORT:-22}"
          echo "Checking public key auth works (BatchMode)..."
          # This should not prompt. If it fails, the error output will usually explain why:
          # - "Load key ...: invalid format" (bad paste / missing newlines)
          # - "Permission denied (publickey)" (wrong key / not in authorized_keys for this user)
          # - "Enter passphrase" (encrypted key; unsupported in this workflow)
          ssh -vvv \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile="$HOME/.ssh/known_hosts" \
            -i "$HOME/.ssh/id_rsa" \
            -p "$SFTP_PORT" \
            "${SFTP_USER}@${SFTP_HOST}" exit || {
              echo "SSH public-key auth failed. Common causes:"
              echo "- Secret SFTP_PRIVATE_KEY was pasted incorrectly (missing BEGIN/END lines or newlines)"
              echo "- The key is encrypted with a passphrase (use an unencrypted deploy key)"
              echo "- The matching public key isn't authorized on the server for this user"
              exit 1
            }

      - name: Deploy (SFTP mirror; main -> root, branches -> /_{branch}/)
        if: ${{ github.event_name != 'pull_request' && env.SFTP_HOST != '' && env.SFTP_USER != '' && env.SFTP_DESTINATION != '' }}
        shell: bash
        run: |
          set -euo pipefail
          trap 'rm -f /tmp/deploy.lftp' EXIT

          if [[ -z "${SFTP_HOST:-}" || -z "${SFTP_USER:-}" || -z "${SFTP_DESTINATION:-}" ]]; then
            echo "Missing required variables. Ensure vars.SFTP_HOST, vars.SFTP_USER, and vars.SFTP_DESTINATION are set."
            exit 1
          fi

          SFTP_PORT="${SFTP_PORT:-22}"

          # main deploys to the configured destination; branches deploy to a preview folder inside it.
          RAW_BRANCH="${GITHUB_REF_NAME}"
          SAFE_BRANCH="$(printf '%s' "$RAW_BRANCH" | tr '/ ' '--' | tr -cd 'A-Za-z0-9._-')"

          BASE_DEST="${SFTP_DESTINATION%/}"
          if [[ "${RAW_BRANCH}" == "main" ]]; then
            DEPLOY_DESTINATION="${BASE_DEST}/"
          else
            DEPLOY_DESTINATION="${BASE_DEST}/_${SAFE_BRANCH}"
          fi

          echo "Deploy destination: ${DEPLOY_DESTINATION}"

          # Prefer key-based auth if provided; otherwise fall back to password (lftp).
          if [[ -n "${SFTP_PRIVATE_KEY:-}" ]]; then
            SSH_BASE=(
              ssh
              -a -x
              -o BatchMode=yes
              -o StrictHostKeyChecking=yes
              -o UserKnownHostsFile="$HOME/.ssh/known_hosts"
              -i "$HOME/.ssh/id_rsa"
              -p "${SFTP_PORT}"
            )

            # Ensure destination exists
            "${SSH_BASE[@]}" "${SFTP_USER}@${SFTP_HOST}" "mkdir -p \"${DEPLOY_DESTINATION}\""

            # Sync repo contents to destination over SSH
            rsync -az --delete --verbose \
              --exclude ".git/" \
              --exclude ".github/" \
              -e "${SSH_BASE[*]}" \
              ./ "${SFTP_USER}@${SFTP_HOST}:${DEPLOY_DESTINATION%/}/"
          else
            if [[ -z "${SFTP_PASSWORD:-}" ]]; then
              echo "Neither secrets.SFTP_PRIVATE_KEY nor secrets.SFTP_PASSWORD is set."
              exit 1
            fi

            CONNECT_PROGRAM="ssh -a -x -o StrictHostKeyChecking=yes -o UserKnownHostsFile=$HOME/.ssh/known_hosts -p ${SFTP_PORT}"
            cat > /tmp/deploy.lftp <<EOF
          set net:timeout 20;
          set net:max-retries 2;
          set sftp:auto-confirm yes;
          set sftp:connect-program "${CONNECT_PROGRAM}";
          open -u "${SFTP_USER},${SFTP_PASSWORD}" "sftp://${SFTP_HOST}";
          mkdir -p "${DEPLOY_DESTINATION}";
          mirror -R --delete --verbose --exclude-glob .git/ --exclude-glob .github/ ./ "${DEPLOY_DESTINATION}";
          bye
          EOF
            lftp -f /tmp/deploy.lftp
          fi


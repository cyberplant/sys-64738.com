name: Compile & Deploy (SFTP)

on:
  push:
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - 'programs/**'
  pull_request:
    paths-ignore:
      - 'programs/**'
  workflow_dispatch:

jobs:
  compile_and_deploy:
    runs-on: ubuntu-latest

    concurrency:
      group: compile-deploy-${{ github.ref }}
      cancel-in-progress: true

    permissions:
      contents: read

    env:
      SFTP_HOST: ${{ vars.SFTP_HOST }}
      SFTP_PORT: ${{ vars.SFTP_PORT }}
      SFTP_USER: ${{ vars.SFTP_USER }}
      SFTP_DESTINATION: ${{ vars.SFTP_DESTINATION }}
      SFTP_PRIVATE_KEY: ${{ secrets.SFTP_PRIVATE_KEY }}
      SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
      SFTP_KNOWN_HOSTS: ${{ secrets.SFTP_KNOWN_HOSTS }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install VICE (petcat)
        run: |
          sudo apt-get update
          sudo apt-get install -y vice
      
      - name: Compile BASIC to PRG
        run: |
          chmod +x compile.sh
          ./compile.sh
      
      - name: List compiled files
        run: |
          echo "ðŸ“¦ Compiled files:"
          ls -lh programs/*.prg programs/*.d64 2>/dev/null || echo "No files found"
      
      - name: Upload compiled files
        uses: actions/upload-artifact@v4
        with:
          name: compiled-files
          path: |
            programs/*.prg
            programs/*.d64
          retention-days: 30

      - name: Install lftp
        if: ${{ github.event_name != 'pull_request' && env.SFTP_HOST != '' && env.SFTP_USER != '' && env.SFTP_DESTINATION != '' }}
        run: sudo apt-get update && sudo apt-get install -y lftp openssh-client

      - name: Prepare SSH config (known_hosts + optional key)
        if: ${{ github.event_name != 'pull_request' && env.SFTP_HOST != '' && env.SFTP_USER != '' && env.SFTP_DESTINATION != '' }}
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"

          if [[ -n "${SFTP_KNOWN_HOSTS:-}" ]]; then
            printf '%s\n' "$SFTP_KNOWN_HOSTS" > "$HOME/.ssh/known_hosts"
          else
            echo "SFTP_KNOWN_HOSTS is not set; generating known_hosts via ssh-keyscan."
            ssh-keyscan -p "${SFTP_PORT:-22}" "$SFTP_HOST" > "$HOME/.ssh/known_hosts"
          fi
          chmod 600 "$HOME/.ssh/known_hosts"

          if [[ -n "${SFTP_PRIVATE_KEY:-}" ]]; then
            printf '%s\n' "$SFTP_PRIVATE_KEY" > "$HOME/.ssh/id_rsa"
            chmod 600 "$HOME/.ssh/id_rsa"
          fi

      - name: Deploy (SFTP mirror; main -> root, branches -> /_{branch}/)
        if: ${{ github.event_name != 'pull_request' && env.SFTP_HOST != '' && env.SFTP_USER != '' && env.SFTP_DESTINATION != '' }}
        shell: bash
        run: |
          set -euo pipefail
          trap 'rm -f /tmp/deploy.lftp' EXIT

          if [[ -z "${SFTP_HOST:-}" || -z "${SFTP_USER:-}" || -z "${SFTP_DESTINATION:-}" ]]; then
            echo "Missing required variables. Ensure vars.SFTP_HOST, vars.SFTP_USER, and vars.SFTP_DESTINATION are set."
            exit 1
          fi

          SFTP_PORT="${SFTP_PORT:-22}"

          # main deploys to the configured destination; branches deploy to a preview folder inside it.
          RAW_BRANCH="${GITHUB_REF_NAME}"
          SAFE_BRANCH="$(printf '%s' "$RAW_BRANCH" | tr '/ ' '--' | tr -cd 'A-Za-z0-9._-')"

          BASE_DEST="${SFTP_DESTINATION%/}"
          if [[ "${RAW_BRANCH}" == "main" ]]; then
            DEPLOY_DESTINATION="${BASE_DEST}/"
          else
            DEPLOY_DESTINATION="${BASE_DEST}/_${SAFE_BRANCH}"
          fi

          echo "Deploy destination: ${DEPLOY_DESTINATION}"

          # Prefer key-based auth if provided; otherwise fall back to password.
          if [[ -n "${SFTP_PRIVATE_KEY:-}" ]]; then
            CONNECT_PROGRAM="ssh -a -x -i $HOME/.ssh/id_rsa -o StrictHostKeyChecking=yes -o UserKnownHostsFile=$HOME/.ssh/known_hosts -p ${SFTP_PORT}"
            cat > /tmp/deploy.lftp <<EOF
          set net:timeout 20;
          set net:max-retries 2;
          set sftp:auto-confirm yes;
          set sftp:connect-program "${CONNECT_PROGRAM}";
          open -u "${SFTP_USER}" "sftp://${SFTP_HOST}";
          mkdir -p "${DEPLOY_DESTINATION}";
          mirror -R --delete --verbose --exclude-glob .git/ --exclude-glob .github/ ./ "${DEPLOY_DESTINATION}";
          bye
          EOF
            lftp -f /tmp/deploy.lftp
          else
            if [[ -z "${SFTP_PASSWORD:-}" ]]; then
              echo "Neither secrets.SFTP_PRIVATE_KEY nor secrets.SFTP_PASSWORD is set."
              exit 1
            fi

            CONNECT_PROGRAM="ssh -a -x -o StrictHostKeyChecking=yes -o UserKnownHostsFile=$HOME/.ssh/known_hosts -p ${SFTP_PORT}"
            cat > /tmp/deploy.lftp <<EOF
          set net:timeout 20;
          set net:max-retries 2;
          set sftp:auto-confirm yes;
          set sftp:connect-program "${CONNECT_PROGRAM}";
          open -u "${SFTP_USER},${SFTP_PASSWORD}" "sftp://${SFTP_HOST}";
          mkdir -p "${DEPLOY_DESTINATION}";
          mirror -R --delete --verbose --exclude-glob .git/ --exclude-glob .github/ ./ "${DEPLOY_DESTINATION}";
          bye
          EOF
            lftp -f /tmp/deploy.lftp
          fi

